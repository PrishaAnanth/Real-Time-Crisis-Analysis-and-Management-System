<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>User Mode â€” Report Crisis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .voice-btn { background:#ff5722;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;margin-left:8px; }
    .voice-btn.active { background:#d32f2f; }
    .actions { margin-top:12px; display:flex; gap:12px; align-items:center; }
  </style>
</head>
<body>
  <header><h1>User Mode</h1></header>

  <main style="max-width:900px;margin:20px auto;padding:16px;">
    <div class="card">
      <form id="crisisForm" method="post" action="{{ url_for('submit_message') }}">
        <label for="message"><strong>Describe the crisis (text or voice)</strong></label><br>
        <div style="display:flex;align-items:flex-start;gap:8px;">
          <textarea id="message" name="message" rows="4" style="flex:1;padding:8px;" placeholder="Describe the problem: e.g. Flooding near the east gate, families need water and blankets..."></textarea>
          <div>
            <button type="button" id="voiceBtn" class="voice-btn" title="Speak your message">ðŸŽ¤ Speak</button>
          </div>
        </div>

        <div class="actions">
          <button class="button" type="submit">Submit Crisis Message</button>
          <a href="{{ url_for('request') }}" class="button secondary" style="text-decoration:none;display:inline-block;padding:8px 12px;">Request Supplies</a>
        </div>

        {% if msg %}
          <p style="margin-top:12px;">{{ msg }}</p>
        {% endif %}
      </form>
    </div>

    <div style="margin-top:18px;">
      <h3>Your Crisis Reports</h3>
      {% if user_issues %}
        {% for issue in user_issues %}
          <div class="complaint {% if issue.status == 'Resolved' %}resolved{% endif %}">
            <p><strong>#{{ issue.id }}</strong> - {{ issue.message }}</p>
            <p class="meta">Status: {{ issue.status }} â€¢ Priority: {{ issue.priority }}</p>
          </div>
        {% endfor %}
      {% else %}
        <p>No crisis reports yet.</p>
      {% endif %}
    </div>
  </main>

  <script>
    // Simple voice-to-text using Web Speech API (if supported)
    const voiceBtn = document.getElementById('voiceBtn');
    const messageBox = document.getElementById('message');
    let recognition = null, recording = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-IN';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => { recording = true; voiceBtn.classList.add('active'); voiceBtn.innerText = 'ðŸŽ™ï¸ Listening...'; };
      recognition.onend = () => { recording = false; voiceBtn.classList.remove('active'); voiceBtn.innerText = 'ðŸŽ¤ Speak'; };
      recognition.onerror = (e) => { console.error(e); recording = false; voiceBtn.classList.remove('active'); voiceBtn.innerText = 'ðŸŽ¤ Speak'; };
      recognition.onresult = (e) => {
        const t = e.results[0][0].transcript || '';
        messageBox.value += (messageBox.value ? ' ' : '') + t;
      };
    } else {
      voiceBtn.disabled = true;
      voiceBtn.title = 'Speech recognition not supported in this browser';
    }

    voiceBtn.addEventListener('click', () => {
      if (!recognition) return;
      if (recording) recognition.stop(); else recognition.start();
    });
  </script>
</body>
</html>
